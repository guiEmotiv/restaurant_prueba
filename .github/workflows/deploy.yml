name: Professional Restaurant Web Deployment

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      action:
        description: 'Deployment Action'
        type: choice
        default: 'deploy'
        options:
          - deploy
          - status
          - logs
          - backup
          - restart
          - ssl-install
          - ssl-renew
          - ssl-test

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: 721063839441.dkr.ecr.us-west-2.amazonaws.com
  ECR_REPOSITORY: restaurant-web

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # INTELLIGENT CHANGE DETECTION
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  analyze-changes:
    runs-on: ubuntu-latest
    name: Analyze Changes
    outputs:
      needs-build: ${{ steps.changes.outputs.needs-build }}
      changes: ${{ steps.changes.outputs.changes }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        
    - name: Detect changes
      id: changes
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "needs-build=true" >> $GITHUB_OUTPUT
          echo "changes=frontend backend infrastructure" >> $GITHUB_OUTPUT
          echo "ðŸ”§ Manual dispatch - building all components"
          exit 0
        fi
        
        # Get changed files
        changes=$(git diff --name-only HEAD~1 HEAD || echo "")
        components=""
        
        # Analyze changes
        if echo "$changes" | grep -qE "^(frontend/|package\.json)"; then
          components="$components frontend"
          echo "ðŸŽ¨ Frontend changes detected"
        fi
        
        if echo "$changes" | grep -qE "^(backend/|requirements\.txt)"; then
          components="$components backend"
          echo "ðŸ”§ Backend changes detected"
        fi
        
        if echo "$changes" | grep -qE "^(docker/|Dockerfile|\.github/)"; then
          components="$components infrastructure"
          echo "ðŸ—ï¸ Infrastructure changes detected"
        fi
        
        # Output results
        if [ -n "$components" ]; then
          echo "needs-build=true" >> $GITHUB_OUTPUT
          echo "changes=$components" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Components to deploy:$components"
        else
          echo "needs-build=false" >> $GITHUB_OUTPUT
          echo "changes=" >> $GITHUB_OUTPUT
          echo "â­ï¸ No significant changes detected, skipping build"
        fi

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # OPTIMIZED BUILD AND DEPLOY
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  
  deploy:
    needs: analyze-changes
    runs-on: ubuntu-latest
    name: Professional Deployment
    environment: production
    if: needs.analyze-changes.outputs.needs-build == 'true' || github.event.inputs.action != ''
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4

    - name: ðŸ” Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: ðŸš¢ Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: ðŸ—ï¸ Intelligent Build and Push
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        VITE_AWS_COGNITO_USER_POOL_ID: ${{ secrets.COGNITO_USER_POOL_ID }}
        VITE_AWS_COGNITO_APP_CLIENT_ID: ${{ secrets.COGNITO_APP_CLIENT_ID }}
        CHANGES: ${{ needs.analyze-changes.outputs.changes || 'frontend backend infrastructure' }}
      run: |
        echo "ðŸ” Building components: $CHANGES"
        
        # Conditional frontend build (only if frontend changed)
        if echo "$CHANGES" | grep -q "frontend" || [ "${{ github.event.inputs.action }}" = "deploy" ] || [ "${{ github.event.inputs.action }}" = "" ]; then
          echo "ðŸŽ¨ Building frontend with optimized settings..."
          cd frontend
          
          # Use npm ci for faster, reliable installs
          npm ci --prefer-offline --no-audit
          
          # Memory-optimized build with Cognito credentials
          NODE_OPTIONS='--max-old-space-size=6144' npm run build
          cd ..
          
          echo "âœ… Frontend build completed"
        else
          echo "â­ï¸ Skipping frontend build (no changes detected)"
        fi
        
        # Build and push Docker image
        echo "ðŸš¢ Building and pushing Docker image..."
        docker build \
          --cache-from $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
          --build-arg BUILDKIT_INLINE_CACHE=1 \
          -f Dockerfile.prod .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        echo "âœ… Docker image pushed successfully"

    - name: ðŸš€ Professional EC2 Deployment
      env:
        ACTION: ${{ github.event.inputs.action || 'deploy' }}
        EC2_HOST: ${{ secrets.EC2_PROD_HOST }}
        EC2_USER: ${{ secrets.EC2_USERNAME }}
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        ECR_REPOSITORY: ${{ env.ECR_REPOSITORY }}
      run: |
        echo "ðŸ” Setting up secure SSH connection..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts
        
        echo "ðŸ“¡ Creating secure deployment payload with JSON..."
        DEPLOYMENT_DATA=$(jq -n \
          --arg ecr_registry "$ECR_REGISTRY" \
          --arg ecr_repository "$ECR_REPOSITORY" \
          --arg action "$ACTION" \
          '{
            ecr_registry: $ecr_registry,
            ecr_repository: $ecr_repository,
            action: $action
          }')
        
        echo "ðŸ“¡ Executing professional deployment on EC2..."
        ssh -o ConnectTimeout=30 -o ServerAliveInterval=60 $EC2_USER@$EC2_HOST << DEPLOY_EOF
        set -e
        export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
        cd /opt/restaurant-web
        
        # Extract variables safely from JSON payload (secure against special characters)
        DEPLOYMENT_JSON='$DEPLOYMENT_DATA'
        export ECR_REGISTRY=\$(echo "\$DEPLOYMENT_JSON" | jq -r '.ecr_registry')
        export ECR_REPOSITORY=\$(echo "\$DEPLOYMENT_JSON" | jq -r '.ecr_repository')
        export ACTION=\$(echo "\$DEPLOYMENT_JSON" | jq -r '.action')
        
        echo "ðŸš€ Executing direct deployment without external scripts..."
        
        # Validate JSON extraction was successful
        if [ "\$ECR_REGISTRY" = "null" ] || [ -z "\$ECR_REGISTRY" ]; then
          echo "âŒ ERROR: Failed to extract ECR_REGISTRY from JSON payload"
          echo "Raw JSON: \$DEPLOYMENT_JSON"
          exit 1
        fi
        
        echo "ðŸ” Debug: ECR_REGISTRY=\$ECR_REGISTRY"
        echo "ðŸ” Debug: ECR_REPOSITORY=\$ECR_REPOSITORY" 
        echo "ðŸ” Debug: ACTION=\$ACTION"
        
        # Create necessary directory structure
        mkdir -p docker data logs
        
        # Create docker-compose.prod.yml dynamically
        cat > docker/docker-compose.prod.yml << EOF
services:
  app:
    image: \${ECR_REGISTRY}/restaurant-web:latest
    container_name: restaurant-web-app
    ports:
      - "8000:8000"
    volumes:
      - ./data:/opt/restaurant-web/data
      - ./logs:/opt/restaurant-web/logs
    environment:
      - DATABASE_PATH=/opt/restaurant-web/data
      - DATABASE_NAME=restaurant.prod.sqlite3
    env_file:
      - .env.ec2
    restart: unless-stopped
    profiles:
      - production
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
  nginx:
    image: nginx:alpine
    container_name: restaurant-web-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - ./data/certbot/www:/var/www/certbot:ro
      - ./data/certbot/conf:/etc/letsencrypt:ro
    depends_on:
      - app
    restart: unless-stopped
    profiles:
      - production
volumes:
  restaurant_data:
    driver: local
  restaurant_logs:
    driver: local
networks:
  default:
    name: restaurant-network
EOF
          
        # Download nginx config
        mkdir -p docker/nginx/conf.d
        curl -sSL --max-time 30 \
          https://raw.githubusercontent.com/guiEmotiv/restaurant-web/main/docker/nginx/conf.d/default.conf \
          -o docker/nginx/conf.d/default.conf
          
        # Execute deployment directly
        echo "ðŸ” Logging into ECR..."
        aws ecr get-login-password --region us-west-2 | docker login --username AWS --password-stdin \$ECR_REGISTRY
        
        echo "ðŸ“¥ Pulling latest Docker image..."
        docker pull \$ECR_REGISTRY/\$ECR_REPOSITORY:latest
        
        echo "ðŸ›‘ Stopping existing containers..."
        docker-compose -f docker/docker-compose.prod.yml --profile production down --timeout 10 || true
        
        echo "â–¶ï¸ Starting production services..."
        docker-compose -f docker/docker-compose.prod.yml --profile production up -d --force-recreate --remove-orphans
        
        echo "â³ Health check..."
        sleep 15
        
        for i in {1..6}; do
          if curl -sf http://localhost:8000/api/v1/health/; then
            echo "âœ… Deployment successful!"
            docker-compose -f docker/docker-compose.prod.yml --profile production ps
            exit 0
          fi
          echo "Health check $i/6 failed, waiting..."
          sleep 10
        done
        
        echo "âŒ Health check failed"
        docker-compose -f docker/docker-compose.prod.yml --profile production logs app --tail=20
        exit 1
        DEPLOY_EOF
        
        echo "âœ… Professional deployment completed successfully"

    - name: ðŸ“Š Deployment Summary
      if: always()
      run: |
        echo "## ðŸŒŸ Professional Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Action:** ${{ env.ACTION || 'deploy' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Changes Detected:** ${{ needs.analyze-changes.outputs.changes || 'manual deployment' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— **Live Site:** https://www.xn--elfogndedonsoto-zrb.com/" >> $GITHUB_STEP_SUMMARY