name: Simple Deploy to Production

on:
  workflow_dispatch:  # Manual trigger only for testing

env:
  AWS_REGION: us-west-2
  ECR_REPOSITORY: restaurant-web

jobs:
  deploy-simple:
    runs-on: ubuntu-latest
    name: Simple Direct Deployment
    
    steps:
    - name: Setup SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        known_hosts: unnecessary
        
    - name: Add EC2 to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.EC2_PROD_HOST }} >> ~/.ssh/known_hosts
        
    - name: Direct Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_PROD_HOST }}
        EC2_USER: ${{ secrets.EC2_USERNAME }}
      run: |
        echo "ðŸš€ Direct deployment to EC2..."
        
        # Single SSH command with PATH fix
        ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'EOF'
        # Fix PATH for non-interactive SSH
        export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games:/snap/bin"
        
        echo "=== Starting Deployment ==="
        echo "Current shell: $SHELL"
        echo "PATH: $PATH"
        echo "Current user: $(whoami)"
        echo "Current directory: $(pwd)"
        
        # Navigate to app directory
        cd /opt/restaurant-web || exit 1
        
        # Simple test: list files
        echo "=== Directory contents ==="
        ls -la
        
        # Check Docker
        echo "=== Docker check ==="
        docker --version || echo "Docker not found"
        docker-compose --version || echo "Docker Compose not found"
        
        # Check AWS CLI
        echo "=== AWS CLI check ==="
        aws --version || echo "AWS CLI not found"
        
        # Check if we can access ECR
        echo "=== ECR Access check ==="
        aws ecr describe-repositories --region us-west-2 || echo "Cannot access ECR"
        
        echo "=== Deployment test completed ==="
        EOF